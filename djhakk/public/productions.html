<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>プロダクション - DJHAKK</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
    <style>
        :root {
            --primary: #FF6B00; --primary-light: #FF8533; --bg: #0D0D1A; --surface: #1A1A2E;
            --card: #252538; --text: #FFFFFF; --text2: #A0A0B8; --text3: #6B6B80; --border: #3A3A50;
            --gradient: linear-gradient(135deg, var(--primary), var(--primary-light));
            --shadow: 0 8px 32px rgba(0,0,0,0.4); --r-md: 12px; --r-lg: 16px; --r-xl: 24px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans JP', 'Outfit', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }
        .header { display: flex; align-items: center; gap: 16px; padding: 16px 0; margin-bottom: 16px; }
        .header-logo { height: 40px; width: 40px; object-fit: contain; cursor: pointer; border-radius: 8px; }
        .header-title { font-size: 20px; font-weight: 700; flex: 1; }
        .search-box { position: relative; margin-bottom: 16px; }
        .search-input { width: 100%; padding: 14px 16px 14px 44px; background: var(--card); border: 1px solid var(--border); border-radius: var(--r-lg); color: var(--text); font-size: 16px; }
        .search-input:focus { outline: none; border-color: var(--primary); }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text3); }
        .filters { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 20px; color: var(--text2); font-size: 13px; cursor: pointer; }
        .filter-btn.active { background: var(--gradient); color: white; border-color: transparent; }
        .card { background: var(--card); border-radius: var(--r-xl); overflow: hidden; margin-bottom: 16px; }
        .card-main { display: flex; cursor: pointer; }
        .card-img { width: 120px; min-width: 120px; height: 160px; object-fit: cover; }
        .card-body { padding: 12px; flex: 1; display: flex; flex-direction: column; }
        .card-title { font-size: 15px; font-weight: 700; margin: 4px 0 8px; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; }
        .badge.audio { background: rgba(255,107,0,0.2); color: #FF6B00; }
        .badge.goods { background: rgba(0,217,255,0.2); color: #00D9FF; }
        .badge.produce { background: rgba(157,78,221,0.2); color: #9D4EDD; }
        .nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 600px; background: var(--surface); display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid var(--border); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text3); cursor: pointer; font-size: 11px; position: relative; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 20px; }
        .nav-unread-badge { position: absolute; top: -4px; right: 50%; transform: translateX(50%); margin-right: -15px; background: #FF4757; color: white; font-size: 10px; font-weight: 700; min-width: 18px; height: 18px; border-radius: 9px; display: none; align-items: center; justify-content: center; padding: 0 4px; }
        .fab { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; background: var(--gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; box-shadow: var(--shadow); cursor: pointer; z-index: 101; border: none; }
        @media (min-width: 600px) { .fab { right: calc(50% - 280px); } }
        /* Interaction Buttons */
        .interaction-buttons { display: flex; gap: 20px; padding: 12px 0; }
        .interaction-btn { display: flex; align-items: center; gap: 6px; background: none; border: none; color: var(--text3); font-size: 14px; cursor: pointer; padding: 4px 0; transition: color 0.2s; }
        .interaction-btn:hover { color: var(--text2); }
        .interaction-btn.like-btn.liked { color: #FF4757; }
        .card-interaction { padding: 0 12px 12px; position: relative; z-index: 10; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 200; overflow-y: auto; }
        .modal.active { display: block; }
        .modal-content { max-width: 600px; margin: 0 auto; min-height: 100vh; background: var(--bg); }
        .modal-header { position: sticky; top: 0; background: var(--bg); padding: 16px; display: flex; align-items: center; z-index: 10; border-bottom: 1px solid var(--border); }
        .modal-close { background: none; border: none; color: var(--text); font-size: 24px; cursor: pointer; }
        .modal-img { width: 100%; aspect-ratio: 1; object-fit: cover; }
        .modal-body { padding: 20px; }
        .modal-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .modal-price { font-size: 28px; font-weight: 700; color: var(--primary); margin-bottom: 16px; }
        .btn { padding: 12px 24px; border-radius: var(--r-lg); font-weight: 600; cursor: pointer; border: none; font-size: 14px; }
        .btn-p { background: var(--gradient); color: white; }
        .btn-lg { width: 100%; padding: 16px; font-size: 16px; }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--card); padding: 12px 24px; border-radius: var(--r-lg); opacity: 0; z-index: 300; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
        
        /* 無限スクロール用 */
        .loading-spinner { display: flex; flex-direction: column; align-items: center; padding: 20px; gap: 8px; }
        .spinner-logo { width: 40px; height: 40px; animation: spinnerRotate 1s linear infinite; }
        @keyframes spinnerRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .loading-spinner span { color: var(--text3); font-size: 12px; }
        .load-more-btn { width: 100%; padding: 16px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--r-lg); color: var(--text); font-weight: 600; cursor: pointer; margin: 16px 0; }
        .load-more-btn:hover { background: var(--card); }
        .no-more-data { text-align: center; padding: 30px; }
        .no-more-data img { width: 48px; height: 48px; opacity: 0.4; }
        
        /* 作成者セクション */
        .card-creator { display: flex; align-items: center; gap: 8px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); }
        .card-creator-avatar { width: 28px; height: 28px; border-radius: 50%; background: var(--gradient); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; overflow: hidden; cursor: pointer; flex-shrink: 0; }
        .card-creator-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .card-creator-name { font-size: 12px; color: var(--text2); cursor: pointer; }
        .card-creator-name:hover { color: var(--text); }
        .card-sns { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .card-desc { font-size: 12px; color: var(--text2); line-height: 1.4; margin-top: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-buy-section { padding: 0 12px 12px; }
        .card-buy-btn { width: 100%; padding: 12px; background: var(--gradient); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 14px; cursor: pointer; }
        
        /* 決済モーダル */
        .payment-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 300; overflow-y: auto; }
        .payment-modal.active { display: block; }
        .payment-modal-content { max-width: 500px; margin: 40px auto; background: var(--card); border-radius: var(--r-xl); overflow: hidden; }
        .payment-modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .payment-modal-header h2 { font-size: 18px; font-weight: 700; }
        .payment-modal-close { background: none; border: none; color: var(--text); font-size: 28px; cursor: pointer; line-height: 1; }
        .payment-modal-body { padding: 20px; }
        .payment-item-info { text-align: center; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border); }
        .payment-item-info h3 { font-size: 18px; margin-bottom: 8px; }
        .payment-seller { color: var(--text2); font-size: 14px; margin-bottom: 8px; }
        .payment-price { font-size: 28px; font-weight: 700; color: var(--primary); }
        .payment-card-section { margin-bottom: 24px; }
        .payment-card-section label { display: block; font-size: 14px; color: var(--text2); margin-bottom: 8px; }
        #card-element { background: var(--surface); padding: 16px; border-radius: var(--r-md); border: 1px solid var(--border); }
        .payment-error { color: #FF4757; font-size: 13px; margin-top: 8px; min-height: 20px; }
        .payment-summary { background: var(--surface); border-radius: var(--r-md); padding: 16px; margin-bottom: 20px; }
        .payment-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; color: var(--text2); }
        .payment-row.total { font-size: 16px; font-weight: 700; color: var(--text); border-top: 1px solid var(--border); margin-top: 8px; padding-top: 16px; }
        .payment-submit-btn { width: 100%; padding: 16px; background: var(--gradient); color: white; border: none; border-radius: var(--r-md); font-size: 16px; font-weight: 700; cursor: pointer; }
        .payment-submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .payment-note { text-align: center; font-size: 12px; color: var(--text3); margin-top: 16px; }
        
        /* カード選択UI */
        .saved-cards-section { margin-bottom: 24px; }
        .saved-cards-section label { display: block; font-size: 14px; color: var(--text2); margin-bottom: 12px; }
        .saved-cards-list { }
        .saved-card-item { background: var(--surface); border: 2px solid var(--border); border-radius: var(--r-md); padding: 14px 16px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: border-color 0.2s; }
        .saved-card-item:hover { border-color: var(--text3); }
        .saved-card-item.selected { border-color: var(--primary); background: rgba(255,107,0,0.1); }
        .saved-card-item.new-card { border-style: dashed; }
        .saved-card-radio { }
        .saved-card-radio input { accent-color: var(--primary); }
        .saved-card-info { flex: 1; display: flex; align-items: center; gap: 8px; }
        .saved-card-brand { font-size: 14px; }
        .saved-card-number { color: var(--text); font-weight: 500; }
        .saved-card-exp { color: var(--text3); font-size: 12px; }
        .new-card-section { margin-bottom: 24px; }
        .new-card-section label { display: block; font-size: 14px; color: var(--text2); margin-bottom: 8px; }
        .save-card-checkbox { display: flex; align-items: center; gap: 8px; margin-top: 12px; font-size: 13px; color: var(--text2); cursor: pointer; }
        .save-card-checkbox input { accent-color: var(--primary); }
        
        /* URL折り返し */
        .modal-body { padding: 20px; word-break: break-word; overflow-wrap: break-word; }
        .modal-body a { word-break: break-all; }
        
        /* カード内波形プレイヤー */
        .card-waveform-section { padding: 0 12px 12px; }
    </style>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" class="header-logo" onclick="window.location.href='timeline.html'">
            <span class="header-title">PRODUCTION</span>
        </div>
        <div class="search-box">
            <span class="search-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></span>
            <input type="text" class="search-input" placeholder="PRODUCTION SEARCH" id="searchInput" oninput="filterProductions()">
        </div>
        <div class="filters">
            <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">ALL</button>
            <button class="filter-btn" data-filter="audio" onclick="setFilter('audio')">DOWNLOAD SALES</button>
            <button class="filter-btn" data-filter="goods" onclick="setFilter('goods')">ITEM SALES</button>
            <button class="filter-btn" data-filter="produce" onclick="setFilter('produce')">SELF PRODUCE</button>
        </div>
        <div id="productionsList"></div>
        
        <!-- 無限スクロール用UI -->
        <div id="loadingSpinner" class="loading-spinner" style="display:none;">
            <img src="logo.png" class="spinner-logo">
            <span>Loading...</span>
        </div>
        <button id="loadMoreBtn" class="load-more-btn" style="display:none;" onclick="loadMoreProductions()">もっと見る</button>
        <div id="noMoreData" class="no-more-data" style="display:none;"><img src="logo.png"></div>
    </div>
    
    <div class="modal" id="productionModal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal()">← Back</button>
            </div>
            <img id="modalImg" class="modal-img" src="logo.png">
            <div class="modal-body">
                <span class="badge audio" id="modalBadge">DOWNLOAD SALES</span>
                <h1 class="modal-title" id="modalTitle"></h1>
                <p class="modal-price" id="modalPrice"></p>
                <div id="modalWaveform" style="margin-bottom: 20px;"></div>
                <div id="modalCreator" style="background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 20px;"></div>
                <div id="modalSns" style="margin-bottom: 16px;"></div>
                <p id="modalDesc" style="color: var(--text2); margin-bottom: 24px; white-space: pre-wrap; word-break: break-word; overflow-wrap: break-word;"></p>
                <button class="btn btn-p btn-lg" onclick="handlePurchase()">Buy</button>
            </div>
        </div>
    </div>
    
    <!-- Floating Action Button -->
    <button class="fab" onclick="handleCreateClick()">+</button>
    
    <nav class="nav">
        <div class="nav-item" onclick="window.location.href='index.html?tab=home'"><span>Home</span></div>
        <div class="nav-item" onclick="window.location.href='events.html'"><span>Event</span></div>
        <div class="nav-item" onclick="window.location.href='timeline.html'"><span>TimeLine</span></div>
        <div class="nav-item active"><span>Production</span></div>
        <div class="nav-item" onclick="window.location.href='place.html'"><span>Place</span></div>
        <div class="nav-item" onclick="handleProfileClick()"><span>Profile</span><span class="nav-unread-badge"></span></div>
    </nav>
    <div class="toast" id="toast"></div>
    
        <!-- Common JS (順序重要: 依存関係順に読み込み) -->
    <script src="js/config.js"></script>
    <script src="js/firebase-init.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/data.js"></script>
    <script src="js/interactions.js"></script>
    <script src="js/audio-player.js"></script>
    <script>
        let allProductions = [];
        let currentFilter = 'all';
        let currentProduction = null;
        let usersCache = {}; // ユーザー情報キャッシュ
        
        function setFilter(f) {
            currentFilter = f;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === f));
            renderProductions();
        }
        
        function filterProductions() { renderProductions(); }
        
        async function loadUserInfo(userId) {
            if (!userId) return null;
            if (usersCache[userId]) return usersCache[userId];
            
            try {
                const doc = await db.collection('users').doc(userId).get();
                if (doc.exists) {
                    usersCache[userId] = doc.data();
                    return usersCache[userId];
                }
            } catch (e) {
                console.log('Error loading user:', e);
            }
            return null;
        }
        
        async function loadAllProductions() {
            allProductions = await loadProductionsInitial();
            
            // ユーザー情報を取得
            const userIds = [...new Set(allProductions.map(p => p.userId).filter(id => id))];
            await Promise.all(userIds.map(id => loadUserInfo(id)));
            
            // いいね状態を取得
            await loadLikedStatusByType(allProductions, 'production');
            
            renderProductions();
            updatePaginationUI('productions');
            setupScrollObserver();
            checkUrlParam();
        }
        
        async function loadMoreProductions() {
            showLoadingSpinner(true);
            
            const moreProductions = await loadProductionsMore();
            if (moreProductions.length > 0) {
                // ユーザー情報を取得
                const userIds = [...new Set(moreProductions.map(p => p.userId).filter(id => id))];
                await Promise.all(userIds.map(id => loadUserInfo(id)));
                
                // いいね状態を取得
                await loadLikedStatusByType(moreProductions, 'production');
                
                allProductions = [...allProductions, ...moreProductions];
                renderProductions();
                setupScrollObserver();
            }
            
            showLoadingSpinner(false);
            updatePaginationUI('productions');
        }
        
        function showLoadingSpinner(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
            document.getElementById('loadMoreBtn').style.display = show ? 'none' : (paginationState.productions?.hasMore ? 'block' : 'none');
        }
        
        function updatePaginationUI(type) {
            const state = getPaginationState(type);
            document.getElementById('loadMoreBtn').style.display = state.hasMore ? 'block' : 'none';
            document.getElementById('noMoreData').style.display = (!state.hasMore && allProductions.length > 0) ? 'block' : 'none';
        }
        
        let scrollObserver;
        function setupScrollObserver() {
            if (scrollObserver) scrollObserver.disconnect();
            
            const cards = document.querySelectorAll('#productionsList .card');
            const triggerIndex = cards.length - PAGINATION.triggerOffset;
            
            if (triggerIndex > 0 && cards[triggerIndex] && paginationState.productions?.hasMore) {
                scrollObserver = new IntersectionObserver((entries) => {
                    if (entries[0].isIntersecting && !paginationState.productions?.loading) {
                        loadMoreProductions();
                    }
                }, { threshold: 0.1 });
                scrollObserver.observe(cards[triggerIndex]);
            }
        }
        
        function renderProductions() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            let filtered = allProductions.filter(p => {
                if (currentFilter !== 'all' && p.type !== currentFilter) return false;
                if (search && !p.title.toLowerCase().includes(search)) return false;
                return true;
            });
            
            const container = document.getElementById('productionsList');
            if (filtered.length === 0) {
                container.innerHTML = `<p style="text-align:center; color: var(--text2); padding: 40px;">${LABELS.noProductions}</p>`;
                return;
            }
            
            let html = '';
            filtered.forEach(p => {
                const liked = isItemLiked('production', p.id);
                const userInfo = usersCache[p.userId] || {};
                html += renderProductionCard(p, liked, userInfo);
            });
            container.innerHTML = html;
        }
        
        function checkUrlParam() {
            const params = new URLSearchParams(location.search);
            const id = params.get('id');
            const action = params.get('action');
            
            if (id) {
                if (action === 'purchase') {
                    // 購入ボタンから来た場合、直接購入処理
                    currentProduction = allProductions.find(p => p.id === id);
                    if (currentProduction) {
                        handlePurchase();
                    }
                } else {
                    // 通常の詳細表示
                    showDetail(id);
                }
            }
        }
        
        function showDetail(id) {
            currentProduction = allProductions.find(p => p.id === id);
            if (!currentProduction) return;
            
            document.getElementById('modalImg').src = currentProduction.imageUrl || 'logo.png';
            document.getElementById('modalBadge').textContent = LABELS.productionTypes[currentProduction.type] || 'ITEM SALES';
            document.getElementById('modalBadge').className = 'badge ' + (currentProduction.type || 'audio');
            document.getElementById('modalTitle').textContent = currentProduction.title;
            document.getElementById('modalPrice').textContent = '¥' + (currentProduction.price||0).toLocaleString();
            
            // DOWNLOAD SALESの場合、波形プレイヤーを表示
            const waveformContainer = document.getElementById('modalWaveform');
            if (currentProduction.type === 'audio' && currentProduction.audioUrl && typeof renderWaveformPlayer === 'function') {
                const waveformHtml = renderWaveformPlayer(
                    currentProduction.audioUrl,
                    currentProduction.title,
                    currentProduction.audioDuration || 0,
                    `modal_${currentProduction.id}`
                );
                waveformContainer.innerHTML = waveformHtml;
                waveformContainer.style.display = 'block';
            } else {
                waveformContainer.innerHTML = '';
                waveformContainer.style.display = 'none';
            }
            
            // 作成者情報
            const userInfo = usersCache[currentProduction.userId] || {};
            const userName = userInfo.name || currentProduction.artistName || 'User';
            const userPhoto = userInfo.photoURL || '';
            const initial = (userName || '?')[0].toUpperCase();
            
            document.getElementById('modalCreator').innerHTML = `
                <div style="font-size: 12px; color: var(--text3); margin-bottom: 12px;">CREATED BY</div>
                <div style="display: flex; align-items: center; gap: 12px; cursor: pointer;" onclick="window.location.href='profile.html?uid=${currentProduction.userId}'">
                    <div style="width: 44px; height: 44px; border-radius: 50%; background: var(--gradient); display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 600; overflow: hidden;">
                        ${userPhoto ? `<img src="${userPhoto}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';this.parentElement.textContent='${initial}'">` : initial}
                    </div>
                    <div style="font-weight: 600;">${userName}</div>
                </div>
            `;
            
            // SNSアイコン
            const snsHtml = renderSnsIcons(userInfo.sns, 32);
            const modalSnsEl = document.getElementById('modalSns');
            if (snsHtml) {
                modalSnsEl.innerHTML = `<div style="font-size: 12px; color: var(--text3); margin-bottom: 8px;">SNS</div><div style="display:flex;gap:12px;flex-wrap:wrap;">${snsHtml}</div>`;
                modalSnsEl.style.display = 'block';
            } else {
                modalSnsEl.style.display = 'none';
            }
            
            // Description（linkify適用）
            document.getElementById('modalDesc').innerHTML = linkifyText(currentProduction.description || '');
            
            document.getElementById('productionModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('productionModal').classList.remove('active');
            history.replaceState(null, '', 'productions.html');
        }
        
        function handlePurchase() {
            if (!requireLogin()) return;
            if (!currentProduction) return;
            
            // 販売者情報を取得
            const sellerInfo = usersCache[currentProduction.userId] || {};
            const sellerName = sellerInfo.name || currentProduction.artistName || 'User';
            
            // 決済用データ
            const paymentData = {
                type: currentProduction.type === 'audio' ? 'download' : (currentProduction.type || 'goods'),
                itemId: currentProduction.id,
                title: currentProduction.title,
                price: currentProduction.price || 0,
                sellerId: currentProduction.userId,
                sellerName: sellerName
            };
            
            // DOWNLOAD SALESの場合、audioUrlを追加
            if (currentProduction.type === 'audio' && currentProduction.audioUrl) {
                paymentData.audioUrl = currentProduction.audioUrl;
            }
            
            // 決済モーダルを開く
            openPaymentModal(paymentData);
        }
        
        function onAuthReady() {
            const params = new URLSearchParams(location.search);
            const hasDeepLink = params.get('id');
            
            // ディープリンクなしで未ログインはウェルカム画面へリダイレクト
            if (!user && !hasDeepLink) {
                window.location.href = 'index.html';
                return;
            }
            loadAllProductions();
        }
    </script>
    <script src="js/stripe.js"></script>
</body>
</html>
