<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Éó„É≠„Éï„Ç£„Éº„É´ - DJHAKK</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
    <style>
        :root {
            --primary: #FF6B00; --primary-light: #FF8533; --bg: #0D0D1A; --surface: #1A1A2E;
            --card: #252538; --text: #FFFFFF; --text2: #A0A0B8; --text3: #6B6B80; --border: #3A3A50;
            --gradient: linear-gradient(135deg, var(--primary), var(--primary-light));
            --shadow: 0 8px 32px rgba(0,0,0,0.4); --r-md: 12px; --r-lg: 16px; --r-xl: 24px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans JP', 'Outfit', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }
        .header { display: flex; align-items: center; gap: 16px; padding: 16px 0; margin-bottom: 24px; }
        .header-logo { height: 40px; width: 40px; object-fit: contain; cursor: pointer; border-radius: 8px; }
        .header-title { font-size: 20px; font-weight: 700; flex: 1; }
        
        .profile-header { text-align: center; margin-bottom: 32px; }
        .avatar-large { width: 100px; height: 100px; border-radius: 50%; background: var(--gradient); display: flex; align-items: center; justify-content: center; font-size: 40px; margin: 0 auto 16px; overflow: hidden; cursor: pointer; }
        .avatar-large img { width: 100%; height: 100%; object-fit: cover; }
        .profile-name { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .profile-email { color: var(--text2); font-size: 14px; }
        
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 12px; background: var(--card); border: 2px solid transparent; color: var(--text2); border-radius: var(--r-md); cursor: pointer; font-weight: 600; text-align: center; font-size: 13px; }
        .tab.active { background: var(--gradient); color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .input-group { margin-bottom: 16px; }
        .label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text2); font-size: 14px; }
        .input { width: 100%; padding: 14px 16px; background: var(--card); border: 1px solid var(--border); border-radius: var(--r-md); color: var(--text); font-size: 16px; }
        .input:focus { outline: none; border-color: var(--primary); }
        textarea.input { resize: vertical; min-height: 80px; }
        
        .btn { padding: 12px 24px; border-radius: var(--r-lg); font-weight: 600; cursor: pointer; border: none; font-size: 14px; }
        .btn-p { background: var(--gradient); color: white; }
        .btn-s { background: var(--card); color: var(--text); }
        .btn-danger { background: #FF4757; color: white; }
        .btn-lg { width: 100%; padding: 16px; font-size: 16px; }
        
        .card { background: var(--card); border-radius: var(--r-xl); overflow: hidden; cursor: pointer; margin-bottom: 16px; display: flex; }
        .card-img { width: 80px; min-width: 80px; height: 100px; object-fit: cover; }
        .card-body { padding: 12px; flex: 1; }
        .card-title { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
        .card-meta { color: var(--text2); font-size: 12px; }
        
        .dm-item { background: var(--card); border-radius: var(--r-lg); padding: 16px; margin-bottom: 12px; cursor: pointer; display: flex; align-items: center; gap: 12px; }
        .dm-avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--gradient); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .dm-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .dm-content { flex: 1; }
        .dm-name { font-weight: 600; margin-bottom: 4px; }
        .dm-preview { color: var(--text2); font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .dm-time { color: var(--text3); font-size: 11px; }
        .dm-unread { background: var(--primary); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; }
        
        .empty-state { text-align: center; padding: 40px; color: var(--text2); }
        
        .nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 600px; background: var(--surface); display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid var(--border); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text3); cursor: pointer; font-size: 11px; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 20px; }
        .nav-create { position: relative; top: -20px; }
        .nav-plus { width: 56px; height: 56px; background: var(--gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; box-shadow: var(--shadow); }
        
        .chat-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg); z-index: 200; }
        .chat-modal.active { display: flex; flex-direction: column; }
        .chat-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
        .chat-back { background: none; border: none; color: var(--text); font-size: 20px; cursor: pointer; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; }
        .chat-message { margin-bottom: 12px; max-width: 80%; }
        .chat-message.mine { margin-left: auto; }
        .chat-bubble { padding: 12px 16px; border-radius: 16px; background: var(--card); }
        .chat-message.mine .chat-bubble { background: var(--primary); }
        .chat-time { font-size: 10px; color: var(--text3); margin-top: 4px; text-align: right; }
        .chat-input-area { padding: 16px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
        .chat-input { flex: 1; padding: 12px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 24px; color: var(--text); font-size: 16px; }
        .chat-send { background: var(--gradient); border: none; border-radius: 50%; width: 44px; height: 44px; color: white; font-size: 20px; cursor: pointer; }
        
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--card); padding: 12px 24px; border-radius: var(--r-lg); opacity: 0; z-index: 300; }
        .toast.show { opacity: 1; }
        .toast.error { background: #FF4757; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" class="header-logo" onclick="location.href='index.html'">
            <span class="header-title">„Éó„É≠„Éï„Ç£„Éº„É´</span>
        </div>
        
        <div class="profile-header">
            <div class="avatar-large" onclick="document.getElementById('avatarInput').click()">
                <img id="avatarImg" style="display:none;">
                <span id="avatarInitial">?</span>
            </div>
            <input type="file" id="avatarInput" accept="image/*" style="display:none;" onchange="uploadAvatar(this)">
            <div class="profile-name" id="profileName">-</div>
            <div class="profile-email" id="profileEmail">-</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('edit')">Á∑®ÈõÜ</div>
            <div class="tab" onclick="switchTab('events')">„Éû„Ç§„Ç§„Éô„É≥„Éà</div>
            <div class="tab" onclick="switchTab('dm')">DM</div>
        </div>
        
        <!-- Edit Profile -->
        <div id="editTab" class="tab-content active">
            <div class="input-group"><label class="label">ÂêçÂâç</label><input type="text" id="editName" class="input"></div>
            <div class="input-group"><label class="label">Ëá™Â∑±Á¥π‰ªã</label><textarea id="editBio" class="input" placeholder="Ëá™Â∑±Á¥π‰ªã„ÇíÂÖ•Âäõ"></textarea></div>
            <div class="input-group"><label class="label">SNS (X/Twitter)</label><input type="url" id="editTwitter" class="input" placeholder="https://x.com/username"></div>
            <div class="input-group"><label class="label">SNS (Instagram)</label><input type="url" id="editInstagram" class="input" placeholder="https://instagram.com/username"></div>
            <button class="btn btn-p btn-lg" onclick="saveProfile()" style="margin-bottom:16px;">‰øùÂ≠ò</button>
            <button class="btn btn-danger btn-lg" onclick="handleLogout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
        </div>
        
        <!-- My Events -->
        <div id="eventsTab" class="tab-content">
            <div id="myEventsList"></div>
        </div>
        
        <!-- DM -->
        <div id="dmTab" class="tab-content">
            <div id="dmList"></div>
        </div>
    </div>
    
    <!-- Chat Modal -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-header">
            <button class="chat-back" onclick="closeChat()">‚Üê</button>
            <span id="chatPartnerName">-</span>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ" onkeypress="if(event.key==='Enter')sendMessage()">
            <button class="chat-send" onclick="sendMessage()">‚Üí</button>
        </div>
    </div>
    
    <nav class="nav">
        <div class="nav-item" onclick="location.href='index.html'"><span class="nav-icon">üè†</span><span>Home</span></div>
        <div class="nav-item" onclick="location.href='events.html'"><span class="nav-icon">üéµ</span><span>Event</span></div>
        <div class="nav-item nav-create" onclick="location.href='create.html'"><div class="nav-plus">+</div></div>
        <div class="nav-item" onclick="location.href='productions.html'"><span class="nav-icon">üíø</span><span>Production</span></div>
        <div class="nav-item active"><span class="nav-icon">üë§</span><span>Profile</span></div>
    </nav>
    <div class="toast" id="toast"></div>
    
    <script src="js/common.js"></script>
    <script>
        let myEvents = [];
        let myChats = [];
        let currentChatId = null;
        let chatUnsub = null;
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach((t,i) => t.classList.toggle('active', ['edit','events','dm'][i] === tab));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            if (tab === 'events') loadMyEvents();
            if (tab === 'dm') loadDMs();
        }
        
        function loadProfileData() {
            if (!userData) return;
            document.getElementById('profileName').textContent = userData.name || '-';
            document.getElementById('profileEmail').textContent = user?.email || '-';
            document.getElementById('editName').value = userData.name || '';
            document.getElementById('editBio').value = userData.bio || '';
            document.getElementById('editTwitter').value = userData.twitter || '';
            document.getElementById('editInstagram').value = userData.instagram || '';
            
            if (userData.photoURL) {
                document.getElementById('avatarImg').src = userData.photoURL;
                document.getElementById('avatarImg').style.display = 'block';
                document.getElementById('avatarInitial').style.display = 'none';
            } else {
                document.getElementById('avatarInitial').textContent = (userData.name || '?')[0].toUpperCase();
            }
        }
        
        async function uploadAvatar(input) {
            if (!input.files || !input.files[0]) return;
            try {
                const blob = await compressImage(input.files[0], 400, 0.8);
                const url = await uploadImageToStorage(blob, `avatars/${user.uid}.jpg`);
                await updateUserData({ photoURL: url });
                document.getElementById('avatarImg').src = url;
                document.getElementById('avatarImg').style.display = 'block';
                document.getElementById('avatarInitial').style.display = 'none';
                toast('„Ç¢„Ç§„Ç≥„É≥„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
            } catch (e) { log('Avatar upload error: ' + e.message); toast('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü','error'); }
        }
        
        async function saveProfile() {
            const data = {
                name: document.getElementById('editName').value.trim(),
                bio: document.getElementById('editBio').value.trim(),
                twitter: document.getElementById('editTwitter').value.trim(),
                instagram: document.getElementById('editInstagram').value.trim()
            };
            if (await updateUserData(data)) {
                document.getElementById('profileName').textContent = data.name || '-';
                toast('„Éó„É≠„Éï„Ç£„Éº„É´„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            } else { toast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü','error'); }
        }
        
        async function handleLogout() {
            if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) await logout();
        }
        
        async function loadMyEvents() {
            const container = document.getElementById('myEventsList');
            try {
                const snapshot = await db.collection('events').where('organizerId', '==', user.uid).orderBy('createdAt', 'desc').get();
                myEvents = [];
                snapshot.forEach(doc => myEvents.push({ id: doc.id, ...doc.data() }));
                
                if (myEvents.length === 0) {
                    container.innerHTML = '<div class="empty-state">‰ΩúÊàê„Åó„Åü„Ç§„Éô„É≥„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                    return;
                }
                
                container.innerHTML = myEvents.map(ev => `
                    <div class="card" onclick="location.href='events.html?id=${ev.id}'">
                        <img src="${ev.imageUrl||'logo.png'}" class="card-img" onerror="this.src='logo.png'">
                        <div class="card-body">
                            <div class="card-title">${ev.title}</div>
                            <div class="card-meta">üìÖ ${formatDate(ev.date)}</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) { log('Error loading events: ' + e.message); container.innerHTML = '<div class="empty-state">Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>'; }
        }
        
        async function loadDMs() {
            const container = document.getElementById('dmList');
            try {
                const snapshot = await db.collection('chats').where('participants', 'array-contains', user.uid).orderBy('lastMessageAt', 'desc').get();
                myChats = [];
                snapshot.forEach(doc => myChats.push({ id: doc.id, ...doc.data() }));
                
                if (myChats.length === 0) {
                    container.innerHTML = '<div class="empty-state">„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                    return;
                }
                
                container.innerHTML = myChats.map(chat => {
                    const partnerId = chat.participants.find(p => p !== user.uid);
                    const partnerName = chat.participantNames?.[partnerId] || '„É¶„Éº„Ç∂„Éº';
                    return `
                        <div class="dm-item" onclick="openChat('${chat.id}','${partnerName}')">
                            <div class="dm-avatar"><span>${partnerName[0]}</span></div>
                            <div class="dm-content">
                                <div class="dm-name">${partnerName}</div>
                                <div class="dm-preview">${chat.lastMessage || ''}</div>
                            </div>
                            <div class="dm-time">${formatDate(chat.lastMessageAt)}</div>
                        </div>
                    `;
                }).join('');
            } catch (e) { log('Error loading DMs: ' + e.message); container.innerHTML = '<div class="empty-state">Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>'; }
        }
        
        function openChat(chatId, partnerName) {
            currentChatId = chatId;
            document.getElementById('chatPartnerName').textContent = partnerName;
            document.getElementById('chatModal').classList.add('active');
            loadMessages();
        }
        
        function closeChat() {
            document.getElementById('chatModal').classList.remove('active');
            if (chatUnsub) { chatUnsub(); chatUnsub = null; }
            currentChatId = null;
        }
        
        function loadMessages() {
            if (!currentChatId) return;
            const container = document.getElementById('chatMessages');
            
            if (chatUnsub) chatUnsub();
            chatUnsub = db.collection('chats').doc(currentChatId).collection('messages').orderBy('createdAt', 'asc').onSnapshot(snapshot => {
                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const isMine = msg.senderId === user.uid;
                    container.innerHTML += `
                        <div class="chat-message ${isMine ? 'mine' : ''}">
                            <div class="chat-bubble">${msg.text}</div>
                            <div class="chat-time">${formatDate(msg.createdAt)}</div>
                        </div>
                    `;
                });
                container.scrollTop = container.scrollHeight;
            });
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !currentChatId) return;
            
            input.value = '';
            try {
                await db.collection('chats').doc(currentChatId).collection('messages').add({
                    text, senderId: user.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await db.collection('chats').doc(currentChatId).update({
                    lastMessage: text, lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (e) { log('Error sending message: ' + e.message); toast('ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü','error'); }
        }
        
        function onAuthReady() {
            if (!user || isGuest) { location.href = 'index.html'; return; }
            loadProfileData();
        }
    </script>
</body>
</html>
